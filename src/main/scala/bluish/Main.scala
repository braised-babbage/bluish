package bluish
import scala.scalajs.js.annotation.{JSExport, JSExportTopLevel}
import org.scalajs.dom
import dom.document
import org.scalajs.dom.html
import scala.util.Random



@JSExportTopLevel("ScalaJSExample")
object ScalaJSExample {


  def update(s: State, dt: Double, keys: KeyState): State = {
    val actors = s.actors.map(a => a.update(dt, s, keys))
    var newState = State(s.level, actors, s.status)

    if (newState.status != Playing)
      return newState

    val player = newState.player

    if (s.level.touches(player.pos, player.size, Lava))
      return State(s.level, actors, Lost)

    for (actor <- actors) {
      if (actor != player && actor.overlaps(player)) {
        newState = actor.collide(newState)
      }
    }
    newState
  }





  @JSExport
  def main(): Unit = {

    val (level,actors) = Level.parse("""
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
................................................................................
..................................................................###...........
...................................................##......##....##+##..........
....................................o.o......##..................#+++#..........
.................................................................##+##..........
...................................#####..........................#v#...........
............................................................................##..
..##......................................o.o................................#..
..#.....................o....................................................#..
..#......................................#####.............................o.#..
..#..........####.......o....................................................#..
..#..@.......#..#................................................#####.......#..
..############..###############...####################.....#######...#########..
..............................#...#..................#.....#....................
..............................#+++#..................#+++++#....................
..............................#+++#..................#+++++#....................
..............................#####..................#######....................
................................................................................
................................................................................
        """)

    var state = State(level, actors, Playing)


    val dt = 20.0 // milliseconds
    val ui = new DomUI()
    ui.draw(state)

    def run() = {

      // clear foreground
      // update state
      // draw
      state = update(state, dt/1000, ui.keys)
      ui.update(state)
      ui.scrollPlayerIntoView(state)
    }

    dom.window.setInterval(() => run, dt)
  }
}
